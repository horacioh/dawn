{% comment %}
  Renders a clean, organized megamenu inspired by Spindrift's minimal design

  Features:
  - Clean text-based navigation with simple images
  - Organized category structure
  - Subtle styling and interactions
  - Optional featured products section

  Usage:
  {% render 'header-custom-megamenu' %}
{% endcomment %}

{%- liquid
  # Get the selected collection for optional product display
  assign megamenu_collection = settings.megamenu_collection
  # Get the position of menu item that should show featured products (1-based)
  assign megamenu_trigger_position = settings.megamenu_trigger_position
-%}

<nav class="header__inline-menu">
  <ul class="list-menu list-menu--inline" role="list">
    {%- for link in section.settings.menu.links -%}
      <li>
        {%- liquid
          # Determine if this menu item should show a megamenu
          assign show_megamenu = false

          # Determine if featured products should show for this menu item
          assign show_featured_products = false
          if megamenu_collection and megamenu_collection.products.size > 0
            # Show on specific position, or on any item with submenu if position is 0
            if megamenu_trigger_position == 0 or forloop.index == megamenu_trigger_position
              assign show_featured_products = true
            endif
          endif

          # Show megamenu if item has submenu items
          if link.links != blank
            assign show_megamenu = true
          endif

          # Show megamenu if this is the designated trigger position with featured products
          if megamenu_trigger_position > 0 and forloop.index == megamenu_trigger_position and show_featured_products
            assign show_megamenu = true
          endif
        -%}
        {%- if show_megamenu -%}
          {%- comment -%} Menu item has submenu OR is the designated featured products trigger - render as clean megamenu {%- endcomment -%}
          <div class="custom-megamenu">
            <div
              class="custom-megamenu__trigger"
              role="button"
              aria-haspopup="true"
              aria-expanded="false"
              data-megamenu-trigger="{{ link.handle }}"
            >
              <span class="header__menu-item list-menu__item link link--text focus-inset{% if link.child_active %} header__active-menu-item{% endif %}">
                <span>{{ link.title | escape }}</span>
                {%- if link.links != blank -%}
                  {{- 'icon-caret.svg' | inline_asset_content -}}
                {%- endif -%}
              </span>
            </div>

            <div
              class="custom-megamenu__dropdown"
              role="menu"
              aria-label="{{ link.title | escape }} menu"
              data-megamenu-dropdown="{{ link.handle }}"
            >
              <div class="custom-megamenu__container page-width">
                {%- comment -%} Product Collection Items Only {%- endcomment -%}
                {%- if show_featured_products -%}
                  <div class="custom-megamenu__products">
                    <div class="custom-megamenu__products-scroll">
                      {%- for product in megamenu_collection.products limit: 12 -%}
                        {%- liquid
                          # Get custom menu image from metafields or fallback to featured image
                          assign menu_image = product.metafields.menu.featured_image
                          if menu_image
                            assign product_image = menu_image
                          else
                            assign product_image = product.featured_image
                          endif
                        -%}
                        <a
                          href="{{ product.url }}"
                          class="custom-megamenu__product-item"
                          aria-label="{{ product.title | escape }}"
                        >
                          {%- if product_image -%}
                            {{
                              product_image
                              | image_url: width: 200, height: 200
                              | image_tag: loading: 'lazy', alt: product.title, sizes: '200px', widths: '200, 400'
                            }}
                          {%- else -%}
                            <div class="custom-megamenu__product-placeholder">
                              {{ 'image' | placeholder_svg_tag }}
                            </div>
                          {%- endif -%}
                        </a>
                      {%- endfor -%}
                    </div>
                  </div>
                {%- endif -%}
              </div>
            </div>
          </div>
        {%- else -%}
          {%- comment -%} Regular menu item without submenu {%- endcomment -%}
          <a
            href="{{ link.url }}"
            class="header__menu-item list-menu__item link link--text focus-inset{% if link.current %} header__active-menu-item{% endif %}"
            {% if link.current %}
              aria-current="page"
            {% endif %}
          >
            <span>{{ link.title | escape }}</span>
          </a>
        {%- endif -%}
      </li>
    {%- endfor -%}
  </ul>
</nav>

{%- style -%}
  /* Custom Megamenu Navigation Styles */
  .custom-megamenu__dropdown {
    display: flex;
    gap: 3rem;
    /* min-height: 300px; */
  }

  .custom-megamenu__container {
    display: flex;
    gap: 2rem;
    flex-grow: 1;
  }

  /* Product Collection Section - Horizontal Scrolling */
  .custom-megamenu__products {
    width: 100%;
    padding: 2rem 0;
  }

  .custom-megamenu__products-scroll {
    display: flex;
    gap: 20px;
    overflow-x: auto;
    padding: 0 20px;
    /* Hide scrollbar */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge */
  }

  .custom-megamenu__products-scroll::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
  }

  .custom-megamenu__product-item {
    flex: 0 0 200px; /* Fixed 200px width, no shrink/grow */
    width: 200px;
    height: 200px;
    display: block;
    text-decoration: none;
    overflow: hidden;
    transition: transform 0.2s ease;
  }

  .custom-megamenu__product-item:hover {
    transform: scale(1.05);
  }

  .custom-megamenu__product-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .custom-megamenu__product-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(var(--color-foreground), 0.08);
    width: 100%;
    height: 100%;
  }

  /* Center items when they fit, left-align when overflowing */
  .custom-megamenu__products-scroll {
    justify-content: center;
  }

  /* Override centering when scrollable (when content overflows) */
  @media screen and (max-width: calc(200px * 4 + 20px * 5 + 40px)) {
    .custom-megamenu__products-scroll {
      justify-content: flex-start;
    }
  }

  /* Responsive adjustments for product items */
  @media screen and (max-width: 1200px) {
    .custom-megamenu__product-item {
      flex: 0 0 180px;
      width: 180px;
      height: 180px;
    }
  }

  @media screen and (max-width: 990px) {
    .custom-megamenu__product-item {
      flex: 0 0 160px;
      width: 160px;
      height: 160px;
    }

    .custom-megamenu__products-scroll {
      gap: 15px;
      padding: 0 15px;
    }
  }

  @media screen and (max-width: 749px) {
    .custom-megamenu__product-item {
      flex: 0 0 140px;
      width: 140px;
      height: 140px;
    }

    .custom-megamenu__products {
      padding: 1.5rem 0;
    }

    .custom-megamenu__products-scroll {
      gap: 12px;
      padding: 0 12px;
    }
  }
{%- endstyle -%}
