{% comment %}
  Renders a clean, organized megamenu inspired by Spindrift's minimal design

  Features:
  - Clean text-based navigation with simple images
  - Organized category structure
  - Subtle styling and interactions
  - Optional featured products section

  Usage:
  {% render 'header-custom-megamenu' %}
{% endcomment %}

{%- liquid
  # Get the selected collection for optional product display
  assign megamenu_collection = settings.megamenu_collection
-%}

<nav class="header__inline-menu">
  <ul class="list-menu list-menu--inline" role="list">
    {%- for link in section.settings.menu.links -%}
      <li>
        {%- if link.links != blank -%}
          {%- comment -%} Menu item has submenu - render as clean megamenu {%- endcomment -%}
          <div class="custom-megamenu">
            <div
              class="custom-megamenu__trigger"
              role="button"
              aria-haspopup="true"
              aria-expanded="false"
              data-megamenu-trigger="{{ link.handle }}"
            >
              <span class="header__menu-item list-menu__item link link--text focus-inset{% if link.child_active %} header__active-menu-item{% endif %}">
                <span>{{ link.title | escape }}</span>
                {{- 'icon-caret.svg' | inline_asset_content -}}
              </span>
            </div>

            <div
              class="custom-megamenu__dropdown"
              role="menu"
              aria-label="{{ link.title | escape }} menu"
              data-megamenu-dropdown="{{ link.handle }}"
            >
              <div class="custom-megamenu__container page-width">
                {%- comment -%} Clean Navigation Section {%- endcomment -%}
                <div class="custom-megamenu__navigation">
                  <div class="custom-megamenu__nav-grid">
                    {%- for childlink in link.links -%}
                      {%- liquid
                        # Get the object (product, page, collection, etc.) from the link
                        assign link_object = childlink.object
                        assign featured_image = null
                        assign fallback_image = null

                        # Check if it's a product
                        if link_object.id and link_object.handle and link_object.featured_image
                          assign fallback_image = link_object.featured_image
                          # Check for featured image meta object
                          if link_object.metafields.menu.featured_image
                            assign featured_image = link_object.metafields.menu.featured_image
                          endif
                          # Check if it's a page
                        elsif link_object.id and link_object.handle and link_object.content
                          # Check for featured image meta object on page
                          if link_object.metafields.menu.featured_image
                            assign featured_image = link_object.metafields.menu.featured_image
                          endif
                          # Check if it's a collection
                        elsif link_object.id and link_object.handle and link_object.products
                          assign fallback_image = link_object.featured_image
                          # Check for featured image meta object on collection
                          if link_object.metafields.menu.featured_image
                            assign featured_image = link_object.metafields.menu.featured_image
                          endif
                        endif

                        # Use featured image if available, otherwise use fallback
                        assign display_image = featured_image | default: fallback_image
                      -%}

                      <div class="custom-megamenu__nav-column">
                        <a
                          href="{{ childlink.url }}"
                          class="custom-megamenu__nav-link{% if childlink.current %} custom-megamenu__nav-link--active{% endif %}"
                          {% if childlink.current %}
                            aria-current="page"
                          {% endif %}
                        >
                          {%- if display_image -%}
                            <img
                              src="{{ display_image | image_url: width: 120 }}"
                              alt="{{ childlink.title | escape }}"
                              class="custom-megamenu__nav-image"
                              loading="lazy"
                              width="120"
                              height="80"
                            >
                          {%- endif -%}
                          <span class="custom-megamenu__nav-title">{{ childlink.title | escape }}</span>
                        </a>

                        {%- if childlink.links != blank -%}
                          <ul class="custom-megamenu__nav-sublist">
                            {%- for grandchildlink in childlink.links -%}
                              <li>
                                <a
                                  href="{{ grandchildlink.url }}"
                                  class="custom-megamenu__nav-sublink{% if grandchildlink.current %} custom-megamenu__nav-sublink--active{% endif %}"
                                  {% if grandchildlink.current %}
                                    aria-current="page"
                                  {% endif %}
                                >
                                  {{ grandchildlink.title | escape }}
                                </a>
                              </li>
                            {%- endfor -%}
                          </ul>
                        {%- endif -%}
                      </div>
                    {%- endfor -%}
                  </div>
                </div>

                {%- comment -%} Optional Featured Products Section {%- endcomment -%}
                {%- if megamenu_collection and megamenu_collection.products.size > 0 -%}
                  <div class="custom-megamenu__featured">
                    <h4 class="custom-megamenu__featured-title">Featured Products</h4>
                    <div class="custom-megamenu__featured-grid">
                      {%- for product in megamenu_collection.products limit: 4 -%}
                        <a href="{{ product.url }}" class="custom-megamenu__featured-item">
                          <div class="custom-megamenu__featured-image">
                            {%- if product.featured_media -%}
                              {{
                                product.featured_media
                                | image_url: width: 200
                                | image_tag: loading: 'lazy', alt: product.title, sizes: '100px', widths: '100, 200'
                              }}
                            {%- else -%}
                              <div class="custom-megamenu__featured-placeholder">
                                {{ 'image' | placeholder_svg_tag }}
                              </div>
                            {%- endif -%}
                          </div>
                          <div class="custom-megamenu__featured-info">
                            <h5 class="custom-megamenu__featured-name">{{ product.title | escape }}</h5>
                            <span class="custom-megamenu__featured-price">{{ product.price | money }}</span>
                          </div>
                        </a>
                      {%- endfor -%}
                    </div>
                    <a href="{{ megamenu_collection.url }}" class="custom-megamenu__view-all">
                      View All {{ megamenu_collection.title | escape }}
                    </a>
                  </div>
                {%- endif -%}
              </div>
            </div>
          </div>
        {%- else -%}
          {%- comment -%} Regular menu item without submenu {%- endcomment -%}
          <a
            href="{{ link.url }}"
            class="header__menu-item list-menu__item link link--text focus-inset{% if link.current %} header__active-menu-item{% endif %}"
            {% if link.current %}
              aria-current="page"
            {% endif %}
          >
            <span>{{ link.title | escape }}</span>
          </a>
        {%- endif -%}
      </li>
    {%- endfor -%}
  </ul>
</nav>

{%- style -%}
  /* Custom Megamenu Navigation Styles */
  .custom-megamenu__dropdown {
    display: flex;
    gap: 3rem;
    min-height: 300px;
  }

  .custom-megamenu__container {
    display: flex;
    gap: 2rem;
    flex-grow: 1;
  }

  .custom-megamenu__navigation {
    flex: 1;
    min-width: 0;
  }

  .custom-megamenu__nav-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.5rem;
  }

  .custom-megamenu__nav-column {
    min-width: 0;
  }

  /* Navigation Link Styles */
  .custom-megamenu__nav-link {
    display: block;
    text-decoration: none;
    color: rgb(var(--color-foreground));
    padding: 0.5rem 0;
    transition: color 0.2s ease;
    font-size: 0.95rem;
    font-weight: 500;
  }

  .custom-megamenu__nav-link:hover {
    color: rgb(var(--color-button));
  }

  .custom-megamenu__nav-link--active {
    color: rgb(var(--color-button));
  }

  .custom-megamenu__nav-title {
    font-size: 1rem;
    font-weight: 600;
    color: rgb(var(--color-foreground));
    margin: 0 0 0.5rem 0;
    line-height: 1.3;
    transition: color 0.2s ease;
  }

  .custom-megamenu__nav-link:hover .custom-megamenu__nav-title {
    color: rgb(var(--color-button));
  }

  .custom-megamenu__nav-sublist {
    list-style: none;
    padding: 0;
    margin: 0;
    margin-top: 0.5rem;
  }

  .custom-megamenu__nav-sublist li {
    margin-bottom: 0.25rem;
  }

  .custom-megamenu__nav-sublink {
    display: block;
    color: rgba(var(--color-foreground), 0.7);
    text-decoration: none;
    padding: 0.25rem 0;
    transition: color 0.2s ease;
    font-size: 0.9rem;
    padding-left: 1rem;
    position: relative;
  }

  .custom-megamenu__nav-sublink:before {
    content: '•';
    position: absolute;
    left: 0;
    color: rgba(var(--color-foreground), 0.4);
  }

  .custom-megamenu__nav-sublink:hover,
  .custom-megamenu__nav-sublink--active {
    color: rgb(var(--color-button));
  }

  /* Featured Products Section */
  .custom-megamenu__featured {
    flex: 0 0 300px; /* Fixed width for featured products */
    border-left: 1px solid rgba(var(--color-foreground), 0.1);
    padding-left: 2rem;
  }

  .custom-megamenu__featured-title {
    font-size: 1.1rem;
    font-weight: bold;
    color: rgb(var(--color-foreground));
    margin: 0 0 1rem 0;
  }

  .custom-megamenu__featured-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .custom-megamenu__featured-item {
    display: flex;
    gap: 1rem;
    text-decoration: none;
    color: rgb(var(--color-foreground));
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    border: 1px solid rgba(var(--color-foreground), 0.1);
  }

  .custom-megamenu__featured-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    border-color: rgba(var(--color-button), 0.3);
  }

  .custom-megamenu__featured-image {
    position: relative;
    width: 100px; /* Fixed width for featured images */
    height: 100px; /* Fixed height for featured images */
    overflow: hidden;
    background: rgba(var(--color-foreground), 0.05);
  }

  .custom-megamenu__featured-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .custom-megamenu__featured-item:hover .custom-megamenu__featured-image img {
    transform: scale(1.05);
  }

  .custom-megamenu__featured-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(var(--color-foreground), 0.08);
  }

  .custom-megamenu__featured-info {
    padding: 0.5rem 0.75rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .custom-megamenu__featured-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: rgb(var(--color-foreground));
    margin: 0 0 0.25rem 0;
    line-height: 1.3;
  }

  .custom-megamenu__featured-price {
    font-size: 0.85rem;
    color: rgb(var(--color-button));
    font-weight: 500;
  }

  .custom-megamenu__view-all {
    display: inline-block;
    text-decoration: none;
    color: rgb(var(--color-button));
    font-size: 0.9rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    transition: all 0.2s ease;
    border: 1px solid rgba(var(--color-button), 0.2);
  }

  .custom-megamenu__view-all:hover {
    background-color: rgba(var(--color-button), 0.1);
    transform: translateY(-1px);
  }

  .custom-megamenu__view-all svg {
    width: 14px;
    height: 14px;
    transition: transform 0.2s ease;
  }

  .custom-megamenu__view-all:hover svg {
    transform: translateX(2px);
  }

  /* Responsive adjustments */
  @media screen and (max-width: 1200px) {
    .custom-megamenu__container {
      flex-direction: column;
      gap: 2rem;
    }

    .custom-megamenu__featured {
      flex: none;
      border-left: none;
      border-top: 1px solid rgba(var(--color-foreground), 0.1);
      padding-left: 0;
      padding-top: 2rem;
    }

    .custom-megamenu__featured-grid {
      grid-template-columns: 1fr;
    }

    .custom-megamenu__nav-grid {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.25rem;
    }

    .custom-megamenu__nav-link {
      font-size: 0.9rem;
    }

    .custom-megamenu__nav-title {
      font-size: 0.9rem;
    }

    .custom-megamenu__nav-sublink {
      font-size: 0.8rem;
    }
  }

  @media screen and (max-width: 990px) {
    .custom-megamenu__dropdown {
      flex-direction: column;
      gap: 2rem;
    }

    .custom-megamenu__container {
      flex-direction: column;
      gap: 2rem;
    }

    .custom-megamenu__featured {
      flex: none;
      border-left: none;
      border-top: 1px solid rgba(var(--color-foreground), 0.1);
      padding-left: 0;
      padding-top: 2rem;
    }

    .custom-megamenu__featured-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .custom-megamenu__nav-grid {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .custom-megamenu__nav-link {
      font-size: 0.8rem;
    }

    .custom-megamenu__nav-title {
      font-size: 0.8rem;
    }

    .custom-megamenu__nav-sublink {
      font-size: 0.75rem;
    }
  }

  @media screen and (max-width: 749px) {
    .custom-megamenu__nav-grid {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
    }

    .custom-megamenu__nav-link {
      font-size: 0.7rem;
    }

    .custom-megamenu__nav-title {
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
    }

    .custom-megamenu__nav-sublink {
      font-size: 0.65rem;
      padding: 0.15rem 0;
    }
  }
{%- endstyle -%}
