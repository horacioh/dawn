{% comment %}
  Renders a clean, organized megamenu inspired by Spindrift's minimal design

  Features:
  - Clean text-based navigation with simple images
  - Organized category structure
  - Subtle styling and interactions
  - Optional featured products section

  Usage:
  {% render 'header-custom-megamenu' %}
{% endcomment %}

{%- liquid
  # Get the selected collection for optional product display
  assign megamenu_collection = settings.megamenu_collection
  # Get the position of menu item that should show featured products (1-based)
  assign megamenu_trigger_position = settings.megamenu_trigger_position
-%}

<nav class="header__inline-menu">
  <ul class="list-menu list-menu--inline" role="list">
    {%- for link in section.settings.menu.links -%}
      <li>
        {%- liquid
          # Determine if this menu item should show a megamenu
          assign show_megamenu = false

          # Determine if featured products should show for this menu item
          assign show_featured_products = false
          if megamenu_collection and megamenu_collection.products.size > 0
            # Show on specific position, or on any item with submenu if position is 0
            if megamenu_trigger_position == 0 or forloop.index == megamenu_trigger_position
              assign show_featured_products = true
            endif
          endif

          # Show megamenu if item has submenu items
          if link.links != blank
            assign show_megamenu = true
          endif

          # Show megamenu if this is the designated trigger position with featured products
          if megamenu_trigger_position > 0 and forloop.index == megamenu_trigger_position and show_featured_products
            assign show_megamenu = true
          endif
        -%}
        {%- if show_megamenu -%}
          {%- comment -%} Menu item has submenu OR is the designated featured products trigger - render as clean megamenu {%- endcomment -%}
          <div class="custom-megamenu">
            <div
              class="custom-megamenu__trigger"
              role="button"
              aria-haspopup="true"
              aria-expanded="false"
              data-megamenu-trigger="{{ link.handle }}"
            >
              <span class="header__menu-item list-menu__item link link--text focus-inset{% if link.child_active %} header__active-menu-item{% endif %}">
                <span>{{ link.title | escape }}</span>
                {%- if link.links != blank -%}
                  {{- 'icon-caret.svg' | inline_asset_content -}}
                {%- endif -%}
              </span>
            </div>

            <div
              class="custom-megamenu__dropdown"
              role="menu"
              aria-label="{{ link.title | escape }} menu"
              data-megamenu-dropdown="{{ link.handle }}"
            >
              <div class="custom-megamenu__container page-width{% if link.links == blank and show_featured_products %} custom-megamenu__container--products-only{% endif %}">
                {%- comment -%} Clean Navigation Section - only show if there are submenu items {%- endcomment -%}
                {%- if link.links != blank -%}
                  <div class="custom-megamenu__navigation">
                    <div class="custom-megamenu__nav-grid">
                      {%- for childlink in link.links -%}
                        {%- liquid
                          # Get the object (product, page, collection, etc.) from the link
                          assign link_object = childlink.object
                          assign featured_image = null
                          assign fallback_image = null

                          # Check if it's a product
                          if link_object.id and link_object.handle and link_object.featured_image
                            assign fallback_image = link_object.featured_image
                            # Check for featured image meta object
                            if link_object.metafields.menu.featured_image
                              assign featured_image = link_object.metafields.menu.featured_image
                            endif
                            # Check if it's a page
                          elsif link_object.id and link_object.handle and link_object.content
                            # Check for featured image meta object on page
                            if link_object.metafields.menu.featured_image
                              assign featured_image = link_object.metafields.menu.featured_image
                            endif
                            # Check if it's a collection
                          elsif link_object.id and link_object.handle and link_object.products
                            assign fallback_image = link_object.featured_image
                            # Check for featured image meta object on collection
                            if link_object.metafields.menu.featured_image
                              assign featured_image = link_object.metafields.menu.featured_image
                            endif
                          endif

                          # Use featured image if available, otherwise use fallback
                          assign display_image = featured_image | default: fallback_image
                        -%}

                        <div class="custom-megamenu__nav-column">
                          <a
                            href="{{ childlink.url }}"
                            class="custom-megamenu__nav-link{% if childlink.current %} custom-megamenu__nav-link--active{% endif %}"
                            {% if childlink.current %}
                              aria-current="page"
                            {% endif %}
                          >
                            {%- if display_image -%}
                              <img
                                src="{{ display_image | image_url: width: 200 }}"
                                alt="{{ childlink.title | escape }}"
                                class="custom-megamenu__nav-image"
                                loading="lazy"
                                width="80"
                                height="80"
                              >
                            {%- endif -%}
                            <span class="custom-megamenu__nav-title">{{ childlink.title | escape }}</span>
                          </a>

                          {%- if childlink.links != blank -%}
                            <ul class="custom-megamenu__nav-sublist">
                              {%- for grandchildlink in childlink.links -%}
                                <li>
                                  <a
                                    href="{{ grandchildlink.url }}"
                                    class="custom-megamenu__nav-sublink{% if grandchildlink.current %} custom-megamenu__nav-sublink--active{% endif %}"
                                    {% if grandchildlink.current %}
                                      aria-current="page"
                                    {% endif %}
                                  >
                                    {{ grandchildlink.title | escape }}
                                  </a>
                                </li>
                              {%- endfor -%}
                            </ul>
                          {%- endif -%}
                        </div>
                      {%- endfor -%}
                    </div>
                  </div>
                {%- endif -%}

                {%- comment -%} Optional Featured Products Section {%- endcomment -%}
                {%- if show_featured_products -%}
                  <div class="custom-megamenu__featured">
                    <h4 class="custom-megamenu__featured-title">Featured Products</h4>
                    <div class="custom-megamenu__featured-grid">
                      {%- for product in megamenu_collection.products limit: 4 -%}
                        {%- liquid
                          # Get custom menu image from metafields or fallback to featured image
                          assign menu_image = product.metafields.menu.featured_image
                          if menu_image
                            assign product_image = menu_image
                          else
                            assign product_image = product.featured_image
                          endif
                        -%}
                        <a
                          href="{{ product.url }}"
                          class="custom-megamenu__featured-item"
                          aria-label="{{ product.title | escape }}"
                        >
                          {%- if product_image -%}
                            {{
                              product_image
                              | image_url: width: 100, height: 100
                              | image_tag: loading: 'lazy', alt: product.title, sizes: '100px', widths: '100, 200'
                            }}
                          {%- else -%}
                            <div class="custom-megamenu__featured-placeholder">
                              {{ 'image' | placeholder_svg_tag }}
                            </div>
                          {%- endif -%}
                        </a>
                      {%- endfor -%}
                    </div>
                    <a href="{{ megamenu_collection.url }}" class="custom-megamenu__view-all">
                      View All {{ megamenu_collection.title | escape }}
                    </a>
                  </div>
                {%- endif -%}
              </div>
            </div>
          </div>
        {%- else -%}
          {%- comment -%} Regular menu item without submenu {%- endcomment -%}
          <a
            href="{{ link.url }}"
            class="header__menu-item list-menu__item link link--text focus-inset{% if link.current %} header__active-menu-item{% endif %}"
            {% if link.current %}
              aria-current="page"
            {% endif %}
          >
            <span>{{ link.title | escape }}</span>
          </a>
        {%- endif -%}
      </li>
    {%- endfor -%}
  </ul>
</nav>

{%- style -%}
  /* Custom Megamenu Navigation Styles */
  .custom-megamenu__dropdown {
    display: flex;
    gap: 3rem;
    min-height: 300px;
  }

  .custom-megamenu__container {
    display: flex;
    gap: 2rem;
    flex-grow: 1;
  }

  .custom-megamenu__navigation {
    flex: 1;
    min-width: 0;
  }

  .custom-megamenu__nav-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.5rem;
  }

  .custom-megamenu__nav-column {
    min-width: 0;
  }

  /* Navigation Link Styles */
  .custom-megamenu__nav-link {
    display: block;
    text-decoration: none;
    color: rgb(var(--color-foreground));
    padding: 0.5rem 0;
    transition: color 0.2s ease;
    font-size: 0.95rem;
    font-weight: 500;
  }

  .custom-megamenu__nav-link:hover {
    color: rgb(var(--color-button));
  }

  .custom-megamenu__nav-link--active {
    color: rgb(var(--color-button));
  }

  .custom-megamenu__nav-title {
    font-size: 1rem;
    font-weight: 600;
    color: rgb(var(--color-foreground));
    margin: 0 0 0.5rem 0;
    line-height: 1.3;
    transition: color 0.2s ease;
  }

  .custom-megamenu__nav-link:hover .custom-megamenu__nav-title {
    color: rgb(var(--color-button));
  }

  .custom-megamenu__nav-sublist {
    list-style: none;
    padding: 0;
    margin: 0;
    margin-top: 0.5rem;
  }

  .custom-megamenu__nav-sublist li {
    margin-bottom: 0.25rem;
  }

  .custom-megamenu__nav-sublink {
    display: block;
    color: rgba(var(--color-foreground), 0.7);
    text-decoration: none;
    padding: 0.25rem 0;
    transition: color 0.2s ease;
    font-size: 0.9rem;
    padding-left: 1rem;
    position: relative;
  }

  .custom-megamenu__nav-sublink:before {
    content: '•';
    position: absolute;
    left: 0;
    color: rgba(var(--color-foreground), 0.4);
  }

  .custom-megamenu__nav-sublink:hover,
  .custom-megamenu__nav-sublink--active {
    color: rgb(var(--color-button));
  }

  /* Featured Products Section */
  .custom-megamenu__featured {
    flex: 0 0 300px; /* Fixed width for featured products */
    border-left: 1px solid rgba(var(--color-foreground), 0.1);
    padding-left: 2rem;
  }

  /* When there's no navigation section, center the featured products */
  .custom-megamenu__container--products-only .custom-megamenu__featured {
    flex: 1;
    border-left: none;
    padding-left: 0;
    max-width: 600px;
    margin: 0 auto;
  }

  .custom-megamenu__container--products-only .custom-megamenu__featured-grid {
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 1.5rem;
    justify-items: center;
  }

  /* Fallback for browsers that support :has() */
  .custom-megamenu__container:not(:has(.custom-megamenu__navigation)) .custom-megamenu__featured {
    flex: 1;
    border-left: none;
    padding-left: 0;
    max-width: 600px;
    margin: 0 auto;
  }

  .custom-megamenu__container:not(:has(.custom-megamenu__navigation)) .custom-megamenu__featured-grid {
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 1.5rem;
    justify-items: center;
  }

  .custom-megamenu__featured-title {
    font-size: 1.1rem;
    font-weight: bold;
    color: rgb(var(--color-foreground));
    margin: 0 0 1rem 0;
  }

  .custom-megamenu__featured-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .custom-megamenu__featured-item {
    display: block;
    width: 100px;
    height: 100px;
    text-decoration: none;
    color: rgb(var(--color-foreground));
    overflow: hidden;
    transition: transform 0.2s ease;
  }

  .custom-megamenu__featured-item:hover {
    transform: scale(1.05);
  }

  .custom-megamenu__featured-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .custom-megamenu__featured-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(var(--color-foreground), 0.08);
    width: 100%;
    height: 100%;
  }

  .custom-megamenu__view-all {
    display: inline-block;
    text-decoration: none;
    color: rgb(var(--color-button));
    font-size: 0.9rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    transition: all 0.2s ease;
    border: 1px solid rgba(var(--color-button), 0.2);
  }

  .custom-megamenu__view-all:hover {
    background-color: rgba(var(--color-button), 0.1);
    transform: translateY(-1px);
  }

  .custom-megamenu__view-all svg {
    width: 14px;
    height: 14px;
    transition: transform 0.2s ease;
  }

  .custom-megamenu__view-all:hover svg {
    transform: translateX(2px);
  }

  /* Responsive adjustments */
  @media screen and (max-width: 1200px) {
    .custom-megamenu__container {
      flex-direction: column;
      gap: 2rem;
    }

    .custom-megamenu__featured {
      flex: none;
      border-left: none;
      border-top: 1px solid rgba(var(--color-foreground), 0.1);
      padding-left: 0;
      padding-top: 2rem;
    }

    .custom-megamenu__featured-grid {
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    }

    .custom-megamenu__nav-grid {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.25rem;
    }

    .custom-megamenu__nav-link {
      font-size: 0.9rem;
    }

    .custom-megamenu__nav-title {
      font-size: 1em;
    }

    .custom-megamenu__nav-sublink {
      font-size: 0.8rem;
    }
  }

  @media screen and (max-width: 990px) {
    .custom-megamenu__dropdown {
      flex-direction: column;
      gap: 2rem;
    }

    .custom-megamenu__container {
      flex-direction: column;
      gap: 2rem;
    }

    .custom-megamenu__featured {
      flex: none;
      border-left: none;
      border-top: 1px solid rgba(var(--color-foreground), 0.1);
      padding-left: 0;
      padding-top: 2rem;
    }

    .custom-megamenu__featured-grid {
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    }

    .custom-megamenu__nav-grid {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .custom-megamenu__nav-link {
      font-size: 0.8rem;
    }

    .custom-megamenu__nav-title {
      font-size: 1em;
    }

    .custom-megamenu__nav-sublink {
      font-size: 0.75rem;
    }
  }

  @media screen and (max-width: 749px) {
    .custom-megamenu__nav-grid {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
    }

    .custom-megamenu__nav-link {
      font-size: 0.7rem;
    }

    .custom-megamenu__nav-title {
      font-size: 1em;
      margin-bottom: 0.25rem;
    }

    .custom-megamenu__nav-sublink {
      font-size: 0.65rem;
      padding: 0.15rem 0;
    }
  }
{%- endstyle -%}
